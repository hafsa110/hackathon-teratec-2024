\chapter{Numerical parameter definition}
\label{ch:num:par:def}

\section{General parameter definition}

First, it is necessary to specify the type of equation to be solved.
The choice is made by using the \telkey{EQUATIONS} keyword, which can take the
following values:

\begin{itemize}
\item 'SAINT-VENANT FE' (default value),

\item 'SAINT-VENANT FV',

\item 'BOUSSINESQ'.
\end{itemize}

The first option involves solving the Saint-Venant equations (or shallow-water
equations) using the finite-element method. This is the "traditional" use of
\telemac{2D}.

It should be noted that all the options available when solving the Saint-Venant
equations using the finite-element method are not necessarily available here.

The 'BOUSSINESQ' option means that the Boussinesq equations are solved.

In addition, it is necessary to specify the type of discretization to be used:
\begin{itemize}
\item linear triangle (3 nodes triangle),
\item quasi-bubble triangle (4 nodes triangle),
\item quadratic triangle (6 nodes triangle).
\end{itemize}
The choice is done with the keyword \telkey{DISCRETIZATIONS IN SPACE}.
This keyword is an array of five integers that are related successively
to the velocity, depth, possible tracer(s), $k$/$\epsilon$
or $\tilde{\nu}$ variables.
For each of these variables,
the value 11 means linear triangle space discretization,
the value 12 means quasi-bubble triangle space discretization
and value 13 means quadratic element.
By default, the value 11 is set for the four variables.
If only setting the first ones, the others are set to the default value 11.

In practice, the user can select the 3 following combinations
(example for the first two variables velocities and water depth):

\begin{itemize}
\item 11 ; 11 (default value) : linear velocity and linear water depth
(recommended),

\item 12 ; 11 : quasi-bubble velocity and linear water depth,

\item 13 ; 11 : quadratic velocity and linear water depth.
\end{itemize}

The first one is the most efficient in terms of memory and CPU time
and the third one is recommended for more accurate results
(but increases significantly the memory and CPU time,
yet every option of computations with \telemac{2D} is not available).
The second one is recommended when observing free surface wiggles
(in particular in case of strong bathymetry gradients).
But in that situation, the recommended configuration is to use the wave equation
associated with the keyword \telkey{FREE SURFACE GRADIENT COMPATIBILITY} = 0.9.
The user can also decrease that value down to 0. if needed.\\

Wave equation (\telkey{TREATMENT OF THE LINEAR SYSTEM} = 2) has not been
implemented for quadratic elements (13).

Weak characteristics and distributive schemes have not been implemented
for quasi-bubble and quadratic elements (12 or 13) either.\\

During computation, \telemac{2D} solves different steps using, if necessary,
the fractional step method (the advection equations and propagation-diffusion
equations may be solved in two successive stages handled by different numerical
schemes).
The user can activate or deactivate some of these steps.

Whether or not the advection terms are taken into account is determined
by the logical keyword \telkey{ADVECTION} (default value = YES).
However, even if this keyword is set at YES, it is possible
to deactivate certain advection terms using the following logical keywords:

\begin{itemize}
\item \telkey{ADVECTION OF H}: to take into account the advection of depth,

\item \telkey{ADVECTION OF U AND V}: for the advection of velocity components,

\item \telkey{ADVECTION OF K AND EPSILON}: for the advection of turbulent energy
and turbulent dissipation ($k-\epsilon$ model)
or the advection of $\tilde{\nu}$ (Spalart-Allmaras model),

\item \telkey{ADVECTION OF TRACERS}: for the advection of tracer(s).
\end{itemize}

The default value of these four keywords is YES.

The phenomena of propagation will or will not be taken into account depending
on the value of the keyword \telkey{PROPAGATION} (default value = YES).
As propagation and diffusion are processed in the same step,
deactivating propagation will automatically entail deactivating diffusion.

However, if the propagation-diffusion step is activated, the user may still
decide whether or not to take into account velocity diffusion by setting
the logical keyword \telkey{DIFFUSION OF VELOCITY} (default value = YES).

The propagation step can be linearized by activating the keyword
\telkey{LINEARIZED PROPAGATION} (default value = NO), in particular when running
a test case for which an analytical solution is available in the linearized case.
It is then necessary to set the water depth around which the
linearization is to be performed, by using the keyword
\telkey{MEAN DEPTH FOR LINEARIZATION} (default value = 0.).


\section{Numerical schemes}

\subsection{Finite elements}
Finite elements resolution is based on the primitive equations.
It is possible to replace the original equations by a generalized wave equation
obtained by eliminating the velocity from the continuity equation using a value
obtained from the momentum equation.
This technique decreases calculation time but has the disadvantage
of smoothing the results.
The choice between these two options is done using the keyword
\telkey{TREATMENT OF THE LINEAR SYSTEM}:
\begin{itemize}
\item 1: original equations (= system of coupled equations,
which was the old default value until release 8.1),
\item 2: wave equation (new default value since release 8.2).
\end{itemize}
It is important to stress that choosing option 2 automatically selects
a number of other options:
use of mass lumping on depth and velocities, and use of explicit velocity
diffusion.
In most cases, option 2 is recommended and offers the optimum in terms of
stability and CPU time.

Another choice concerns the scheme used for solving the advection step.
To do this, the user has to update the keyword \telkey{TYPE OF ADVECTION}.
This keyword is an array of four integers that are related successively
to the scheme used for advection of the velocity ($U$ and $V$), depth ($H$),
tracer and turbulent values ($k$ and $\epsilon$, or $\tilde{\nu}$).
If the model does not include any tracer or turbulence model,
the user may simply give the first two values.

Since release 6.0, the value concerning depth is ignored by \telemac{2D}.
The optimum numerical scheme is automatically selected by the code
(conservative scheme).

Alternatively to \telkey{TYPE OF ADVECTION}, the keyword
\telkey{SCHEME FOR ADVECTION OF VELOCITIES} can be used.

Each integer may have a value between 1 and 15, corresponding to the following
possibilities:

\begin{itemize}
\item 1: Method of characteristics, not mass-conservative,

\item 2: Centred semi implicit scheme + SUPG
(Streamline Upwind Petrov Galerkin),

\item 3: Upwind explicit finite volume
(referenced as 8 before release 6.0), mass-conservative,

\item 4: N distributive scheme, mass-conservative,

\item 5: PSI distributive scheme, mass-conservative,
%Deleted!%
%\item 6: PSI scheme on non-conservative equation (obsolete),
%
%\item 7: Implicit N scheme on non-conservative equation (obsolete),

\item 13: Edge by edge implementation of scheme 3
(will work on tidal flats), mass-conservative,

\item 14: Edge by edge implementation of scheme 4
(will work on tidal flats), mass-conservative,

\item 15: ERIA scheme (will work on tidal flats), mass-conservative.
\end{itemize}

Schemes 3 and 4 on the one hand, and 13 and 14 on the other hand, are equal
in 2D (they are not in 3D) and correspond to the so called NERD scheme.

The stability of the N and the PSI scheme (type of advection 4 and 5)
is conditioned by a Courant number lower than 1.
When using these schemes, \telemac{2D} checks the Courant number
for each point at each time step.
If the Courant number is greater than 1, the software will automatically execute
intermediate time steps in order to satisfy the stability condition.
However, if the number of sub-iterations reaches 200, \telemac{2D} will consider
that solving the advection term is no longer possible and the computation is
stopped with an appropriate error message printed in the output listing.

The distributive schemes N and PSI have been improved from release 7.0 to deal
with time dependent problems. Several options are offered to the user through
the keyword \telkey{SCHEME OPTION FOR ADVECTION OF VELOCITIES}, which can be set to:
\begin{itemize}
\item 1: explicit scheme (default value),
\item 2: first order predictor-corrector scheme,
\item 3: second order predictor-corrector scheme,
\item 4: locally semi-implicit predictor-corrector scheme
(for tidal flats): LIPS.
\end{itemize}
In addition, the predictor-corrector schemes need an additional parameter
which represents the number of iterations for every time step (or sub-time step)
to converge to the solution.
The keyword \telkey{NUMBER OF CORRECTIONS OF DISTRIBUTIVE SCHEMES}
plays this role and it is useful for unsteady cases.
For quasi-steady flows, the
\telkey{NUMBER OF CORRECTIONS OF DISTRIBUTIVE SCHEMES}
does not have a large impact on the solution, so it can be left to its default value.
On the other hand, for unsteady flows, it is suggested to set the keyword
\telkey{NUMBER OF CORRECTIONS OF DISTRIBUTIVE SCHEMES} to 2 (at least),
which is a good compromise between accuracy and computational time.
Indeed, increasing the number of corrections the scheme is more accurate
but the CPU time rapidly increases.
The keyword \telkey{NUMBER OF CORRECTIONS OF DISTRIBUTIVE SCHEMES}
can be used with
\telkey{SCHEME FOR ADVECTION OF...} = 3, 4, 5 or 15 AND
\telkey{SCHEME OPTION FOR ADVECTION OF...} = 2, 3 or 4.

The keyword \telkey{MAXIMUM NUMBER OF ITERATIONS FOR ADVECTION SCHEMES}
enables to limit the number of solver iterations for the advection schemes
of type NERD or ERIA (\telkey{SCHEME FOR ADVECTION OF}... = 13, 14 or 15).
The default value is 50 (old default value = 10 until release 8.1).

The keyword \telkey{NUMBER OF SUB-STEPS OF DISTRIBUTIVE SCHEMES} can only be
activated for locally semi-implicit predictor-corrector schemes aka LIPS
(\telkey{SCHEME FOR ADVECTION OF...} = 3, 4 or 5
+ \telkey{SCHEME OPTION FOR ADVECTION OF...} = 4).
The default value is 1.
As the keyword mentions, it allows to subdivide the time step given by the user
in the steering file, into several sub-steps.
Again, it produces an effect on the precision of the scheme and it is convenient
to set this keyword in order to have Courant numbers not too large (around 1).

\begin{WarningBlock}{Note:}
\begin{itemize}

\item If present, the keyword \telkey{SCHEME OPTION FOR ADVECTION OF VELOCITIES}
replaces and has priority over the following keywords:
\telkey{OPTION FOR CHARACTERISTICS} and \telkey{SUPG OPTION}.

\item The same remark are valid for advection of tracer, $k$, $\epsilon$ and
$\tilde{\nu}$.
However there are dedicated keywords: \telkey{SCHEME FOR ADVECTION OF TRACERS}
and \telkey{SCHEME FOR ADVECTION OF K-EPSILON}
(see sections \ref{sec:num:spec} and \ref{sec:mod:turbul}),

\item \telkey{MATRIX STORAGE} = 3 is mandatory with a distributive scheme
for advection (= 3, 4, 5, 13, 14 or 15).
In addition, \telkey{SUPG OPTION} for water depth = 0. (i.e. no upwinding) is
mandatory for a distributive scheme with tidal flats (13, 14 or 15).
%SUPG OPTION for water depth = 0. previously written mandatory
%for schemes 3, 4 and 5 in v8p2, but this was not true.
\end{itemize}
\end{WarningBlock}

The default value for \telkey{TYPE OF ADVECTION} is 1;5;1;1, which corresponds
to the use of the method of characteristics in all cases, except for the depth
for which the appropriate conservative scheme is selected by the code.
Note that the value 5 in second position does not mean
``PSI distributive scheme' but is the value used by the previous release
of \telemac{2D} to select the conservative scheme for depth.

The default value is kept for compatibility of old studies,
but a recommended value is: 1;5;4 or 4;5;4 when there are no dry zones,
and 1;5;14 or 14;5;14 when there are tidal flats.
For dam break studies option 14;5 is recommended.

The keyword \telkey{TYPE OF ADVECTION} will be soon replaced
by the following keywords (already active):
\begin{itemize}
\item \telkey{SCHEME FOR ADVECTION OF VELOCITIES} (default = 1),
\item \telkey{SCHEME FOR ADVECTION OF TRACERS} (default = 1),
\item \telkey{SCHEME FOR ADVECTION OF K-EPSILON} (default = 1).
\end{itemize}
The keyword for advection of water depth is not necessary, since the scheme is
automatically selected by \telemac{2D}, as already said here above.

Depending on the scheme used, accuracy may be improved by running sub-iterations.
This involves updating the advection field for the same time step over several
sub-iterations.
During the first sub-iteration, the velocity field is given by the results
obtained at the previous time step.
The number of sub-iterations is set by the keyword
\telkey{NUMBER OF SUB-ITERATIONS FOR NON-LINEARITIES},
which has a default value of 1.
This option is time consuming but it can be helpful for some studies
like dam-break studies.

In \telemac{2D} time discretization is semi-implicit.
The various implicitation coefficients are given with the keywords
\telkey{IMPLICITATION FOR DEPTH}
(corresponding to the \telfile{TETAC} FORTRAN variable, default = 0.55),
\telkey{IMPLICITATION FOR VELOCITY}
(corresponding to the \telfile{TETAU} FORTRAN variable, default = 0.55),
\telkey{IMPLICITATION FOR DIFFUSION OF VELOCITY}
(corresponding to the \telfile{TETAD} FORTRAN variable, default = 1.),
and in the case of computing tracer transport,
\telkey{IMPLICITATION COEFFICIENT OF TRACERS}
(corresponding to the \telfile{TETAT} FORTRAN variable, default = 0.6).
The default values are generally adequate.

The reader's attention is drawn to the fact that in earlier releases of
\telemac{2D} and under certain conditions,
the value of some parameters could be arbitrarily set in the code regardless
of the specified keywords value.
%
%Following lines were relevant for an old release as 6.2, but should not be
%written now, commented for history
%
%Thus, when using the wave equation (2 value of the keyword
%\telkey{TREATMENT OF THE LINEAR SYSTEM}), the implicitation of the depth and
%velocity was imposed to 1 in release 6.0.
%In release 6.1, only \telkey{IMPLICITATION FOR DEPTH} was still imposed to 1.
%As a result, the transition from one release to another can provide
%different results if the \telkey{STEERING FILE} has not been updated.
%
%For example, if a calculation has been performed in release 6.0
%using the wave equation, the \telkey{STEERING FILE} must be adapted
%in the following way to get the same results:

%\begin{itemize}
%\item In release 6.1:
%\begin{lstlisting}[language=bash]
%TREATMENT OF THE LINEAR SYSTEM = 2
%IMPLICITATION FOR VELOCITY = 1.0
%\end{lstlisting}
%\item From release 6.2 on:
%\begin{lstlisting}[language=bash]
%TREATMENT OF THE LINEAR SYSTEM = 2
%IMPLICITATION FOR VELOCITY = 1.0
%IMPLICITATION FOR DEPTH = 1.0
%\end{lstlisting}
%\end{itemize}

When solving the linearized system $A.X = B$, \telemac{2D} offers the
possibility of mass-lumping on the mass matrices
($M^h$ for depth, $M^u$ and $M^v$ for velocities) involved in computing the
matrices $AM1$ for depth, and $AM2$ and $AM3$ for velocity
(see \cite{Hervouet2007} for more details).
This technique means bringing some or all of the matrix on to the diagonal,
and enables computation times to be shortened considerably.
However, the solution obtained is more smoothed.
The mass-lumping rate is set with the keywords \telkey{MASS-LUMPING ON H},
\telkey{MASS-LUMPING ON VELOCITY} and
\telkey{MASS-LUMPING FOR WEAK CHARACTERISTICS}.
The value 1. indicates maximum mass-lumping (the mass matrices are diagonal)
and the value 0. (default value) corresponds to normal processing
without mass-lumping.

As the mass-lumping is applied only on time derivatives,
it does not change steady state results.\\

If using \telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS} = 1 (default value)
and \telkey{TREATMENT OF NEGATIVE DEPTHS} = 2 (flux control),
the keyword \telkey{MASS-LUMPING ON H} must be equal to 1.

The keyword \telkey{MASS-LUMPING ON TRACERS} is read but automatically replaced
by the value of \telkey{MASS-LUMPING ON H} to ensure tracer mass conservation.

As told at the beginning of this subsection, if using
\telkey{TREATMENT OF THE LINEAR SYSTEM} = 2 (wave equation) automatically
changes \telkey{MASS-LUMPING ON VELOCITY} to value 1.


\subsubsection{Configuration of the SUPG scheme}

When using the SUPG method, the user has to determine the type of upwinding
desired with the keyword \telkey{SUPG OPTION} which, like the keyword
\telkey{TYPE OF ADVECTION}, is an array of 4 integers
related to the velocities, the water depth, tracer(s) and $k-\epsilon$ model
(or Spalart-Allmaras model) respectively.
Default value = (2;2;2;2).

The possible values are the following:

\begin{itemize}
\item 0: No upwind scheme,

\item 1: Upwind scheme with the classical SUPG method,
i.e. upwind scheme = 1,

\item 2: Upwind scheme with the modified SUPG method,
i.e. upwinding equal to the Courant number.
\end{itemize}

In theory, option 2 is more accurate when the Courant number is less than 1,
but must not be used for large Courant numbers.
Thus, option 2 should be used only for models in which the Courant number is
very low.
If the Courant number cannot be estimated, it is strongly recommended
to use option 1 (which can be considered as more ''universal'').

The configuration of the SUPG method concerns option 2 of the keyword
\telkey{TYPE OF ADVECTION} but the second number for \telkey{SUPG OPTION}
applies to the depth (even if the SUPG method cannot be selected for the
advection of water depth).
If it is 1 or 2, the corresponding extra term that SUPG would bring
to the advection of the depth,
i.e. the part due to upwind, is added to the continuity equation.
This "advection of the depth" appears when the term $div(h\vec{u})$ is split
into $h div(\vec{u}) + \vec{u}grad(h)$.
This SUPG treatment is mathematically not far from adding a diffusion
or from smoothing the depth and it has a powerful effect on stability,
e.g. in cases with hydraulic jumps.
However this numerical trick cannot be used with tracers,
since the presence of the extra term in the continuity equation breaks
the tracer mass conservation (it has no effect on the water mass conservation).

\subsubsection{Configuration of the weak characteristics}

When choosing the method of characteristics, two forms can be used with the
keyword \telkey{OPTION FOR CHARACTERISTICS}:

\begin{itemize}
\item 1: the strong form (by default),
\item 2: the weak form.
\end{itemize}

If one component of array \telkey{TYPE OF ADVECTION} = 1 or
\telkey{SCHEME FOR ADVECTION OF...} = 1,
and also the corresponding keyword
\telkey{SCHEME OPTION FOR ADVECTION OF...} =~2,
\telkey{OPTION FOR CHARACTERISTICS} is automatically set to 2.\\

None of the two choices for \telkey{OPTION FOR CHARACTERISTICS}
are recommended for the advection of tracers because they are not
mass conservative. The weak form will decrease the diffusion. If the keyword
\telkey{MASS-LUMPING FOR WEAK CHARACTERISTICS} = 1. (default value = 0. i.e. no
mass-lumping), monotonicity of the scheme appears. This weak form should be
more conservative than the strong form. The \telkey{NUMBER OF GAUSS POINTS FOR
WEAK CHARACTERISTICS} defines the number of Gauss points used to compute the
weak characteristics.
Possible choices for \telemac{2D} are:
\begin{itemize}
\item 1 point,
\item 3 points (default value),
\item 4 points,
\item 6 points,
\item 7 points,
\item 12 points.
\end{itemize}
The bigger the number is, the more conservative the scheme is, but the higher the
computational costs are.

\subsection{Finite volumes}

When using the finite volume scheme, the primitive equations written
in conservative form are solved. The finite volume schemes use control volumes
which are centered around the triangular mesh nodes and are also referred to as
the dual mesh cells. The dual mesh is defined from
the barycentre of the primal mesh triangles (cf. Figure \ref{fv:dual_mesh}).

\begin{figure}[h!]
\centering
\includegraphics*[width=0.45\textwidth]{./graphics/vf_cell.pdf}
\caption{Triangular mesh (black) and finite volume dual mesh (red)}
\label{fv:dual_mesh}
\end{figure}

\subsubsection{Numerical schemes for the hyperbolic part}

The keyword \telkey{FINITE VOLUME SCHEME} specifies the type of scheme used
to solve the hyperbolic part of the shallow water system.
The available possibilities are:

\begin{itemize}
\item 0: Roe scheme. See \cite{roe1981approximate} for more details.

\item 1: Kinetic scheme (default value). See \cite{audusse2000kinetic}.

\item 3: Zokagoa scheme (implementation not compatible with tidal flats).
See \cite{zokagoa2010modeling}.

\item 4: Tchamen scheme,

\item 5: HLLC (Harten Lax Leer-Contact) scheme,
which is one the most frequently used scheme in the literature
\cite{toro2009hll}.

\item 6: WAF (Weighted Average Flux) scheme (parallel not implemented).
For more details about this scheme, see \cite{Ata2012}.
\end{itemize}

The algorithm of finite volume schemes is explicit which means that
the Courant number must be inferior or equal to 1 to ensure stability.
It is however recommended to set the keyword \telkey{DESIRED COURANT NUMBER}
to 0.9. This should be combined with the keyword \telkey{VARIABLE TIME-STEP}
set to YES (default: NO).
\telemac{2D} then adjusts the calculation time step so as to satisfy
this Courant number criterion.
The graphic printout is handled with the time step given in the steering file.
However, it should be noted that this leads to irregular sampling
from the control listing.

The keyword \telkey{OPTION OF THE HYDROSTATIC RECONSTRUCTION}
enables to choose the option for hydrostatic reconstruction for the
Kinetic, HLLC and WAF schemes.
The 2 possible choices are:
\begin{itemize}
\item 1: Audusse \textit{et al.} \cite{audusse2004fast} (default),
\item 2: Chen and Noelle improvement \cite{Chen2017},
which is useful for rain induced runoff (work only with first
order in space schemes).
\end{itemize}

The keyword \telkey{FINITE VOLUME SCHEME SPACE ORDER} (default = 1) allows the
use of second order reconstructions which gives second order accuracy for
spatial schemes.
The 2 possible choices are:
\begin{itemize}
\item 1: First order (default value),
\item 2: Second order MUSCL scheme \cite{bristeau2005secondorder} (only compatible with
Kinetic and HLLC schemes).
\end{itemize}

When second order MUSCL scheme is used, the keywords \telkey{FLUX LIMITOR FOR H PLUS Z},
\telkey{FLUX LIMITOR FOR U AND V} and \telkey{FLUX LIMITOR FOR TRACERS}
allow the user to switch between several second order TVD flux limitors for
the reconstructions of free surface, velocities and tracers.
The available choices are:
\begin{itemize}
\item 1:  Minmod (default value for H+Z),
\item 2:  Van Albala (default value for U, V and tracers),
\item 3:  MC (Monotonized Central)
\item 4:  Generalized minmod
\end{itemize}

Similarly the keyword \telkey{FINITE VOLUME SCHEME TIME ORDER} (default = 1)
gives the possibility to use second order accurate temporal scheme.
 The 2 possible choices are:
\begin{itemize}
\item 1: Euler explicit scheme (default value),
\item 2: Newmark scheme.
\end{itemize}
The keyword \telkey{NEWMARK TIME INTEGRATION COEFFICIENT} (default = 0.5)
gives the possibility to change the Newmark scheme integration parameter.
When set to 1 the Newmark scheme is equivalent to the Euler
explicit time scheme.

\subsubsection{Numerical schemes for the parabolic part}

To solve the parabolic part of the shallow water system i.e. the diffusion of velocities
and tracers the keywords \telkey{FINITE VOLUME SCHEME FOR VELOCITY DIFFUSION} as well as
\telkey{FINITE VOLUME SCHEME FOR TRACER DIFFUSION} can be used
to specify the type of schemes used. For the tracer diffusion scheme choice, one value
by tracer must be set.
The available possibilities are:
\begin{itemize}
\item 1: Explicit P1 finite element scheme (default value),
\item 2: TPF (Two Points Flux) finite volume scheme,
\item 3: RTPF (Reconstructed Two Points Flux) finite volume scheme.
\end{itemize}

The first scheme is a finite element P1 explicit scheme with mass lumping which
does not require the resolution of a linear system.
The scheme gives a second order accuracy for the parabolic part and
has specifically been implemented to work alongside finite volume
hyperbolic schemes.

The second option corresponds to the finite volume two point flux scheme (TPF)
which is not consistent in the case of the \telemac{2D} dual mesh.
It is available for comparison purposes but should be used carefully.
Instead of the classic two point flux scheme, the third option is advised.
The finite volume reconstructed two point flux scheme (RTPF) consists in
reconstructing the fields to ensure consistency of the diffusion flux.

Two options are available for the reconstructions of the RTPF scheme, which 
can be selected via the keyword \telkey{OPTION FOR THE RTPF SCHEME RECONSTRUCTIONS}.
The first option (default value) uses a simple linear reconstruction
based on gradients on adjacent triangles of the interfaces which gives a
first order accuracy for the parabolic part. The second option uses dual mesh
cell gradients.

For each scheme, both Neumann and Dirichlet boundary conditions are implemented.
For the Dirichlet boundary condition, it is possible to choose the type of
imposition (weak or strong) with the keyword
\telkey{OPTION FOR DIRICHLET CONDITION IN FV DIFFUSION}.
The available possibilities are:
\begin{itemize}
\item 1: weak (default value),
\item 2: strong.
\end{itemize}

The numerical schemes implemented for the diffusion being all explicit, the
resolution requires to fulfill a condition on the time step, namely the Fourier
condition (similar to the CFL condition).
As a consequence, the Fourier number must be set
via the keyword \telkey{DESIRED FOURIER NUMBER}
to a value inferior or equal to 1 to ensure stability.
This should be combined with the keyword \telkey{VARIABLE TIME-STEP}
set to YES (default: NO).

\section{Solving the linear system}

This section only concerns Finite Elements method.
\subsection{Solver}

During some steps, the solver used for solving the systems of equations
can be selected through the following keywords:

\begin{itemize}
\item \telkey{SOLVER}: for the hydrodynamic propagation step
(default value = 3),

\item \telkey{SOLVER FOR DIFFUSION OF TRACERS}: for the tracers diffusion step
(default value = 1),

\item \telkey{SOLVER FOR K-EPSILON MODEL}:
for solving the $k-\epsilon$ model system or Spalart-Allmaras model system
(default value = 1).
\end{itemize}

Each keyword may have a value between 1 and 8.
These values correspond to the following possibilities.
Options 1 to 6 are all related to the conjugate gradient method:

\begin{itemize}
\item 1: Conjugate gradient method (when the matrix of the system to solve
is symmetric),

\item 2: Conjugate residual method,

\item 3: Conjugate gradient on normal equation method,

\item 4: Minimum error method,

\item 5: Squared conjugate gradient method,

\item 6: BICGSTAB (stabilised biconjugate gradient) method,

\item 7: GMRES (Generalised Minimum RESidual) method,

\item 8: Direct solver (YSMP, solver of the Yale university),
does not work in parallel mode.

%\item 9: MUMPS solver: it is a specific direct solver that may work
%in parallel but requires the installation of extra libraries.
\end{itemize}

The GMRES method is well suited for improperly conditioned systems.
If the GMRES method is used, the dimension of the Krylov space has to be
specified with the appropriate keyword, i.e.:

\begin{itemize}
\item \telkey{SOLVER OPTION}: for hydrodynamic propagation,

\item \telkey{SOLVER OPTION FOR TRACERS DIFFUSION}: for tracer(s) diffusion,

\item \telkey{OPTION FOR THE SOLVER FOR K-EPSILON MODEL}:
for the $k-\epsilon$ model or Spalart-Allmaras model.
\end{itemize}

By default, \telemac{2D} uses the conjugate gradient on normal equation method
(option 3) for solving the propagation step
and the conjugate gradient method (option 1) for solving tracer diffusion and
the $k-\epsilon$ model or the Spalart-Allmaras model.
If the wave equation is used (\telkey{TREATMENT OF THE LINEAR SYSTEM} = 2),
\telkey{SOLVER} = 1 is recommended.

The GMRES method with a Krylov space dimension equal to 2 or 3 seems
to fit most cases in 2D, when solving primitive equations,
but the optimum value of this parameter generally increases with the mesh size.

The conjugate gradient is generally recommended for symmetric linear systems,
thus when solving the wave equation or the diffusion equations.


\subsection{Accuracy}

When the linearized system is solved by an iterative method, it is necessary
to give the accuracy that is to be achieved during the solving process and
the maximum number of iterations permissible, to prevent the computation
from entering unending loops if the required accuracy is not achieved.

Accuracy is specified with the following keywords:

\begin{itemize}
\item \telkey{SOLVER ACCURACY} : defines the accuracy required during solution
of the propagation step (default value = 10$^{-4}$),

\item \telkey{ACCURACY FOR DIFFUSION OF TRACERS}: defines the accuracy required
during the computation of tracer diffusion (default value = 10$^{-6}$),

\item \telkey{ACCURACY OF K}: defines the accuracy required during the diffusion
and source terms step of the turbulent energy transport equation
(default value = 10$^{-9}$),

\item \telkey{ACCURACY OF EPSILON}: defines the accuracy required during the
computation of diffusion and source terms step of the turbulent dissipation
transport equation (default value = 10$^{-9}$),

\item \telkey{ACCURACY OF SPALART-ALLMARAS}: defines the accuracy required
during the diffusion and source terms step of the Spalart-Allmaras equation
(default value = 10$^{-9}$).
\end{itemize}

The maximum number of iterations is specified with the following keywords:

\begin{itemize}
\item \telkey{MAXIMUM NUMBER OF ITERATIONS FOR SOLVER}:
defines the maximum permissible number of iterations
when solving the propagation step (default value = 100),

\item \telkey{MAXIMUM NUMBER OF ITERATIONS FOR DIFFUSION OF TRACERS}:
defines the maximum permissible number of iterations
when solving the tracers diffusion step (default value = 60),

\item \telkey{MAXIMUM NUMBER OF ITERATIONS FOR K AND EPSILON}:
defines the maximum permissible number of iterations when solving the diffusion
and source terms step of the $k-\epsilon$ transport equations
or the Spalart-Allmaras equation (default value = 50).
\end{itemize}

The user may obtain information on the solvers by activating the keywords
\telkey{INFORMATION ABOUT SOLVER} and, if the $k-\epsilon$ turbulence model
is used, \telkey{INFORMATION ABOUT K-EPSILON MODEL}.
The same keyword exists for the Spalart-Allmaras turbulence model
(\telkey{INFORMATION ABOUT SPALART-ALLMARAS MODEL}).
The default value of the 3 previous keywords is YES.
This information is provided in the listing printout
and may be of the following two types:
\begin{itemize}
\item Either the process has converged before reaching the maximum permissible
number of iterations, and in this case \telemac{2D} provides the number of
iterations actually run and the accuracy achieved,
\item Or the process has not converged quickly enough.
\telemac{2D} then displays the message ``MAXIMUM NUMBER OF ITERATIONS REACHED''
and the accuracy actually achieved.
In some cases, and if the number of iterations is already set
at a high value (e.g. more than 120), the convergence may still be improved
by decreasing the time step or by modifying the mesh.
\end{itemize}

\subsection{Continuity correction}

Residual mass errors (of the order of a few percent) may appear when using
boundary conditions with imposed depth (case of a river downstream).
Indeed the continuity equation is not solved for these points and is replaced
by the equation depth = imposed value.
Therefore, the resultant discharge is not properly computed and leads to error.
The keyword \telkey{CONTINUITY CORRECTION} helps in correcting the velocity
at these points so that the overall continuity is verified.
This correction has enabled the error to be divided by as much as 1,000.
The default value is NO.

When using \telkey{TREATMENT OF NEGATIVE DEPTH} = 2 or 3 with tidal flats,
it is mandatory to activate \telkey{CONTINUITY CORRECTION} = YES.


\subsection{Preconditioning}

When solving a system of equations by an iterative linear solver,
convergence can often be accelerated by means of preconditioning.

\telemac{2D} offers several possibilities for preconditioning.
These are selected with the keywords \telkey{PRECONDITIONING},
\telkey{PRECONDITIONING FOR DIFFUSION OF TRACERS},
and \telkey{PRECONDITIONING FOR K-EPSILON MODEL}
(the last one, common to the $k-\epsilon$ and Spalart-Allmaras models).

The possibilities may be different depending on the keywords.

The keyword \telkey{PRECONDITIONING} concerns the propagation solution step,
and can have the following values:

\begin{itemize}
\item 0: No preconditioning,

\item 2: Diagonal preconditioning (default value),

\item 3: Block diagonal preconditioning,

\item 5: Diagonal preconditioning with absolute value,

\item 7: Crout preconditioning per element (does not work in parallel),

\item 11: Gauss-Seidel EBE preconditioning
(not convenient for parallelism),

\item 13: preconditioning supplied by the user.
\end{itemize}

The keyword \telkey{PRECONDITIONING FOR DIFFUSION OF TRACERS}
concerns the tracer diffusion solution step, and can have the following values:

\begin{itemize}
\item 0: No preconditioning,

\item 2: Diagonal preconditioning (default value),

%\item 3: Block diagonal preconditioning, ???

\item 5: Diagonal preconditioning with absolute value,

\item 7: Crout preconditioning per element (does not work in parallel),

\item 11: Gauss-Seidel EBE preconditioning
(not convenient for parallelism),

\item 13: preconditioning supplied by the user.
\end{itemize}

The keyword \telkey{PRECONDITIONING FOR K-EPSILON MODEL} concerns
the turbulence model solution step (for both $k-\epsilon$ and Spalart-Allmaras
models), and can have only the following values:

\begin{itemize}
\item 0: No preconditioning,

\item 2: Diagonal preconditioning (default value),

\item 3: Block diagonal preconditioning,

\item 5: Diagonal preconditioning with absolute value,

\item 7: Crout preconditioning per element (does not work in parallel),

\item 11: Gauss-Seidel EBE preconditioning
(not convenient for parallelism),

\item 13: preconditioning supplied by the user.
\end{itemize}

Some options of preconditioning can be cumulated,
namely the diagonal ones with the others.
As the base values are prime numbers, two options are cumulated by assigning
the keyword the value of the product of the two options to be cumulated.

The block-diagonal preconditioning can only be used
when solving the primitive equations (it is not valid with the wave equation).

In addition, when the propagation step is being solved,
convergence may possibly be improved by modifying the initial value taken
for water depth $H$ at the start of the solving process.
The user may then assign the keyword \telkey{INITIAL GUESS FOR H}
any of the following values:

\begin{itemize}
\item 0: Initial value of $DH$ = $H_{n+1}$ - $H_n$ null,

\item 1: Initial value of $DH$ equal to the value of $DH$
at the previous time step (default value),

\item 2: $DH$ = 2$DH_n$ - $DH_{n-1}$ in which $DH_n$ is the value of
$DH$ at the previous time step and $DH_{n-1}$ the value of $DH$ two time steps
before.
This is in fact an extrapolation.
\end{itemize}

The same process may be used for the velocity by using the keyword
\telkey{INITIAL GUESS FOR U}.
The possibilities are the same as before, but apply to $U$ (or $V$)
and not to the increase of $U$ (or $V$).


\subsection{C-U preconditioning}

When solving the linear system, $C-U$ preconditioning consists
in replacing the unknown depth by the celerity.
This technique was used automatically in the old releases of the software
and is now configurable as an option with the keyword
\telkey{C-U PRECONDITIONING}.
The default value is YES.
This technique is very useful in sea modelling but not in river modelling.
It is not activated with the wave equation
(\telkey{TREATMENT OF THE LINEAR SYSTEM} = 2).


\section{Courant number management}

During a model simulation, the Courant number value (number of grid cells
crossed by a water particle during a time step) considerably influences
the quality of the results.
Irrespective of numerical schemes with a stability condition on the Courant
number, experience shows that result quality decreases if the Courant number is
above 7 or 8.
Yet it is not so easy to estimate the value of the Courant number
- especially in sea models with a large tidal range.
To help, \telemac{2D} allows the user to check the Courant number during
computation:
the software automatically executes intermediate time steps
so that the Courant number keeps below a given value.

This function is activated using the keyword \telkey{VARIABLE TIME-STEP}
(default value = NO) and the maximum Courant number value can be specified using
the keyword \telkey{DESIRED COURANT NUMBER} (default value = 1).

It should be stressed that when a variable time step is used,
sampling from the results file and control listing is no longer regular in time,
as it depends directly on the time step value.


\section{Tidal flats}
This section mainly concerns Finite Elements schemes, indeed for Finite Volumes
(\telkey{EQUATIONS} = 'SAINT-VENANT FV') no specific treatment for tidal flat
is required.
All the options cited hereafter are then useless.\\

\telemac{2D} offers several processing options for tidal flat areas
when Finite Elements schemes are used.

First of all, if the user is sure that the model will contain no tidal flats
throughout the simulation, these may be deactivated by assigning NO
to the keyword \telkey{TIDAL FLATS} (the default value is YES).
This may mean that computational time can be saved.

To model tidal flats, the main keywords involved are:
\begin{itemize}
\item \telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS}:
three different ways can be chosen to process tidal flats,
\item \telkey{SCHEME FOR ADVECTION OF VELOCITIES}
(\telkey{OF TRACERS} or \telkey{OF K-EPSILON}):
only a few schemes are suitable for tidal flats,
\item \telkey{TREATMENT OF NEGATIVE DEPTHS}: three different options are
available.
\end{itemize}

Tidal flats can be processed in three different ways setting the keyword
\telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS}:

\begin{itemize}
\item 1: The tidal flats are detected and the free surface gradient
is corrected,

\item 2: The tidal flat areas are removed from the computation.
Exposed elements still form part of the mesh but any contributions they make
to the computations are cancelled by a so-called "masking" table.
The data structure and the computations are thus formally the same to
within the value of the masking coefficient.
However, in this case, mass-conservation may be slightly altered,

\item 3: Processing is done in the same way as in the first case,
but a porosity term is added to half-dry elements.
Consequently, the quantity of water is changed and is no longer equal
to the depth integral over the whole domain but to the depth integral
multiplied by the porosity.
The user can modify the porosity value determined by the processing in the
\telfile{USER\_CORPOR} subroutine.
\end{itemize}


The treatment of the negative depths can be specified using the keyword
\telkey{TREATMENT OF NEGATIVE DEPTHS}.
Value 1 (default value) is the previously only option consisting in smoothing
the negative depths in a conservative way.
The option 2 (since release 6.0) is a flux limitation
that ensures strictly positive depths.
So is option 3 for ERIA advection scheme.
This must be preferably coupled with the advection schemes able to cope
with tidal flats (+ \telkey{MASS-LUMPING ON H} = 1.
+ \telkey{CONTINUITY CORRECTION} = YES
+ \telkey{SUPG OPTION} for water depth = 0, i.e. no SUPG upwinding on depth).
This option is however recommended when conservative tracers are modelled
using distributive schemes (\telkey{SCHEME FOR ADVECTION OF TRACERS} = 4 or 5):
it allows to obtain a perfect mass balance. Value 0 means no treatment.

The numerical advection schemes (keywords \telkey{TYPE OF ADVECTION}
or \telkey{SCHEME FOR ADVECTION OF}...) for tidal flats are:
\begin{itemize}
\item 13 or 14: NERD scheme,
\item 4 or 5 coupled with \telkey{OPTION FOR ADVECTION OF}... = 4:
LIPS scheme,
\item 15: ERIA scheme.
\end{itemize}

\begin{WarningBlock}{Note:}
NERD schemes (13 and 14) require the keywords
  \telkey{TIDAL FLATS} = YES (default)
+ \telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS} = 1 (default)
+ \telkey{TREATMENT OF NEGATIVE DEPTHS} = 2 and then
  \telkey{MASS-LUMPING ON H} = 1.
+ \telkey{CONTINUITY CORRECTION} = YES
+ \telkey{SUPG OPTION} for water depth = 0.

ERIA scheme (= 15) requires the keywords
  \telkey{TIDAL FLATS} = YES (default)
+ \telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS} = 1 (default)
+ \telkey{TREATMENT OF NEGATIVE DEPTHS} = 3 and then
  \telkey{MASS-LUMPING ON H} = 1.
+ \telkey{CONTINUITY CORRECTION} = YES
+ \telkey{SUPG OPTION} for water depth = 0.

LIPS requires the keywords
  \telkey{TIDAL FLATS} = YES (default)
+ \telkey{OPTION FOR THE TREATMENT OF TIDAL FLATS} = 1 (default)
and allows the two types of \telkey{TREATMENT OF NEGATIVE DEPTHS} = 2 or 3.
It then also needs:
  \telkey{MASS-LUMPING ON H} = 1.
+ \telkey{CONTINUITY CORRECTION} = YES
+ \telkey{SUPG OPTION} for water depth = 0.

Note also that NERD and ERIA cannot be used simultaneously.
\end{WarningBlock}

The keyword \telkey{THRESHOLD FOR NEGATIVE DEPTHS} (default = 0.)
is only used with \telkey{TREATMENT OF NEGATIVE DEPTHS} = 1.
It specifies the limit of the unchanged value.
For example, \telkey{THRESHOLD FOR NEGATIVE DEPTHS} = -0.01 means
that depths greater than --1~cm will be left unchanged.

In some cases, it may be advisable to limit the lower water depth value.
The most common case involves eliminating negative values of $H$.
To do this, the user assigns the value YES to the keyword \telkey{H CLIPPING}
(default value = NO).
The keyword \telkey{MINIMUM VALUE OF DEPTH} which has a default value of 0.,
is used to set the threshold below which clipping is performed.
However, it should be born in mind that this latter option may lead
to an increase in the mass of water as it eliminates negative water depths.

\section{Other parameters}

\subsection{Matrix storage}

\telemac{2D} includes 2 different methods of matrix storage:
an Element by Element (EBE) method and an edge-based method.
The second is faster (about 20\%) in most cases.

The choice between the two storage methods can be done using the keyword
\telkey{MATRIX STORAGE}, with the following values:

\begin{itemize}
\item 1: classical Element by Element (EBE) method,

\item 3: edge-based storage method (default and recommended value).
\end{itemize}

\telkey{MATRIX STORAGE} = 3 is mandatory with a distributive scheme
for advection (= 3, 4, 5, 13, 14 or 15).
It is also mandatory when using a direct system solver (\telkey{SOLVER...} = 8).


\subsection{Matrix-vector product}

Two matrix-vector product methods are included in \telemac{2D}:
a classical method for the multiplication of a vector by a non-assembled matrix
and a more recent method of frontal multiplication with an assembled matrix.
The keyword \telkey{MATRIX-VECTOR PRODUCT} switches between the two methods:

\begin{itemize}
\item 1: multiplication of a vector by a non-assembled matrix
(default and recommended value),

\item 2: frontal multiplication with an assembled matrix.
\end{itemize}

When using the frontal matrix-vector product,
the number of neighbors of the points in the mesh is limited to 10 so far.

Option 2 is not implemented in parallel and is then automatically changed to 1
(with a warning message).
Moreover, option 2 is not implemented for quasi-bubble elements.


\subsection{Finite Element assembly mode in parallel}

When assembling Finite Elements in parallel, \telemac{2D} has several options
to do it since some works on reproducibility for \tel
(see Rafife Nheili's PhD thesis).
It can be done directly with double precision values
(option 1 = default value)
or with integers to avoid truncation errors in parallel, due to different
order of additions of more than 2 numbers.
The choice can be done with the keyword \telkey{FINITE ELEMENT ASSEMBLY}
which can get the following values:
\begin{itemize}
\item 1: normal (default value),
\item 2: with I8 integers,
\item 3: compensation (for reproducibility).
\end{itemize}
Caution: only some parts of \telemac{2D} have been implemented
with \telkey{FINITE ELEMENT ASSEMBLY} different from 1
(e.g. propagation step) and the whole code is not fully available
in compensated mode.


\section{Convergence study}

To assess the accuracy of numerical schemes, the computation of errors
on several meshes is needed.
\telemac{2D} offers the possibility to carry out a mesh convergence
by activating the keyword \telkey{CONVERGENCE STUDY} (default = NO).
The resulting solutions are then compared to an analytical solution
on a fine mesh.\\

The user has to give the number of refinement levels with the keyword
\telkey{REFINEMENT LEVELS} (default = 0).
Each level multiplies the number of triangular elements by 4 with \stbtel.

This option is only available in sequential mode
(\telkey{PARALLEL PROCESSORS} = 0 or 1, or Python option -{}-ncsize = 0 or 1).
